"use client"

import { useMemo } from "react";
import { useMarketplaceListings } from "@/hooks/use-marketplace-events";
import { normalizeStarknetAddress } from "@/lib/utils";
import { SUPPORTED_TOKENS } from "@/lib/constants";

const formatPrice = (amount: string, decimals: number = 18): string => {
    try {
        const val = BigInt(amount);
        return (Number(val) / Math.pow(10, decimals)).toFixed(decimals <= 6 ? 2 : 4);
    } catch {
        return "0";
    }
};

const getCurrencyInfo = (tokenAddress: string): { symbol: string; decimals: number } => {
    const normalized = normalizeStarknetAddress(tokenAddress).toLowerCase();
    for (const token of SUPPORTED_TOKENS) {
        if (normalizeStarknetAddress(token.address).toLowerCase() === normalized) {
            return { symbol: token.symbol, decimals: token.decimals };
        }
    }
    return { symbol: "TOKEN", decimals: 18 };
};

/**
 * Derives the true collection floor price from all active listings
 * for a given NFT contract address. Reuses the already-fetched allOrders
 * from useMarketplaceListings â€” no extra RPC calls.
 */
export function useCollectionFloor(nftAddress?: string) {
    const { allOrders } = useMarketplaceListings();

    return useMemo(() => {
        if (!nftAddress || !allOrders.length) return null;
        const now = Math.floor(Date.now() / 1000);
        const normalized = normalizeStarknetAddress(nftAddress).toLowerCase();

        const activeListings = allOrders.filter(o =>
            o.status === "active" &&
            o.endTime > now &&
            o.offerType === "ERC721" &&
            normalizeStarknetAddress(o.offerToken).toLowerCase() === normalized
        );

        if (!activeListings.length) return null;

        const min = activeListings.reduce((a, b) =>
            BigInt(a.considerationAmount) < BigInt(b.considerationAmount) ? a : b
        );

        const { symbol, decimals } = getCurrencyInfo(min.considerationToken);
        return { formattedPrice: formatPrice(min.considerationAmount, decimals), symbol };
    }, [allOrders, nftAddress]);
}
